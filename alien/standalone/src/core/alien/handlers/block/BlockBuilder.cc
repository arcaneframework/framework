/* Author : desrozis at Thu Mar 14 12:29:22 2013
 * Generated by createNew
 */

#include <alien/utils/Precomp.h>
#include "alien/index_manager/IIndexManager.h"
#include "BlockBuilder.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

namespace Alien
{
/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

BlockBuilder::SizeVector::
SizeVector(BlockBuilder& block_Builder, ConstArrayView<Integer> indexes)
: m_block_Builder(block_Builder)
, m_indexes(indexes)
{}

/*---------------------------------------------------------------------------*/

void BlockBuilder::SizeVector::
operator=(Integer size)
{
  for (Integer i = 0; i < m_indexes.size(); ++i) {
    if (m_block_Builder.isLocal(m_indexes[i]))
      m_block_Builder[m_indexes[i]] = size;
  }
}

/*---------------------------------------------------------------------------*/

void BlockBuilder::SizeVector::
operator+=(Integer size)
{
  for (Integer i = 0; i < m_indexes.size(); ++i) {
    if (m_block_Builder.isLocal(m_indexes[i]))
      m_block_Builder[m_indexes[i]] += size;
  }
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

BlockBuilder::
BlockBuilder(IIndexManager& index_mng)
: m_index_mng(index_mng)
{
  if (not index_mng.isPrepared())
    index_mng.prepare();

  Integer global_size, local_size;
  index_mng.stats(global_size, m_offset, local_size);
  m_next_offset = m_offset + local_size;

  m_sizes.resize(local_size);
  m_sizes.fill(0);
}

/*---------------------------------------------------------------------------*/

BlockBuilder::SizeVector
BlockBuilder::
operator[](ConstArrayView<Integer> indexes)
{
  return SizeVector(*this, indexes);
}

/*---------------------------------------------------------------------------*/

Integer&
BlockBuilder::
operator[](Integer index)
{
  return m_sizes[index - m_offset];
}

/*---------------------------------------------------------------------------*/

const BlockSizes::ValuePerBlock&
BlockBuilder::
sizes() const
{
  if (m_sizes_computed)
    return m_block_sizes.sizes();

  m_block_sizes.prepare(m_index_mng, m_sizes);

  m_sizes_computed = true;

  return m_block_sizes.sizes();
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/
} // namespace Alien
