name: ci-ifpen_linux_el7_gimkl-2018b_by-components_external

on:
  push:
    branches: [ main, dev/ci_ifpen ]
  pull_request:
    branches: [ main, dev/ci_ifpen ]
  workflow_dispatch:
    branches: [ main, dev/ci_ifpen ]

env:
  # Arcane
  ARCANE_BUILD_DIR: /__w/framework/framework/arcane_build
  ARCANE_INSTALL_DIR: /__w/framework/framework/arcane_install
  ARCANE_SOURCE_DIR: /__w/framework/framework/arcane
  # Arccon
  ARCCON_BUILD_DIR: /__w/framework/framework/arccon_build
  ARCCON_INSTALL_DIR: /__w/framework/framework/arccon_install
  ARCCON_SOURCE_DIR: /__w/framework/framework/arccon
  # Arccore
  ARCCORE_BUILD_DIR: /__w/framework/framework/arccore_build
  ARCCORE_INSTALL_DIR: /__w/framework/framework/arccore_install
  ARCCORE_SOURCE_DIR: /__w/framework/framework/arccore
  # ArcDependencies
  ARCDEPENDENCIES_BUILD_DIR: /__w/framework/framework/arcdependencies_build
  ARCDEPENDENCIES_INSTALL_DIR: /__w/framework/framework/arcdependencies_install
  ARCDEPENDENCIES_SOURCE_DIR: /__w/framework/framework/arcdependencies
  # Axlstar
  AXLSTAR_BUILD_DIR: /__w/framework/framework/axlstar_build
  AXLSTAR_INSTALL_DIR: /__w/framework/framework/axlstar_install
  AXLSTAR_SOURCE_DIR: /__w/framework/framework/axlstar
  # CMake
  CM_BUILD_TYPE: Debug
  # CTest
  CT_OPTS: --output-on-failure

jobs:
  arccon-install:
    name: arccon-install
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/arcaneframework/centos-gimkl-2018b-arcane:7-latest
      credentials:
        username: ${{ secrets.ci_ifpen_read_packages_username }}
        password: ${{ secrets.ci_ifpen_read_packages_password }}
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository_owner }}/arccon
          path: arccon
          ref: main
          submodules: true
      - name: Configure
        shell: bash
        run: |
          source /env.sh
          cmake -S ${{ env.ARCCON_SOURCE_DIR }} -B ${{ env.ARCCON_BUILD_DIR }} -DCMAKE_BUILD_TYPE=${{ env.CM_BUILD_TYPE }} -DCMAKE_INSTALL_PREFIX=${{ env.ARCCON_INSTALL_DIR }}
      - name: Build
        shell: bash
        run: |
          source /env.sh
          cmake --build ${{ env.ARCCON_BUILD_DIR }}
      - name: Install
        shell: bash
        run: |
          source /env.sh
          cmake --install ${{ env.ARCCON_BUILD_DIR }}
      - name: Upload install artifact
        uses: actions/upload-artifact@v2
        with:
          name: arccon-install-artifact
          path: |
            ${{ env.ARCCON_INSTALL_DIR }}
          retention-days: 1

  arccore-install:
    needs:
      - arccon-install
    name: arccore-install
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/arcaneframework/centos-gimkl-2018b-arcane:7-latest
      credentials:
        username: ${{ secrets.ci_ifpen_read_packages_username }}
        password: ${{ secrets.ci_ifpen_read_packages_password }}
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository_owner }}/arccore
          path: ${{ env.ARCCORE_SOURCE_DIR }}
          ref: main
          submodules: true
      - name: Download arccon install artifact
        uses: actions/download-artifact@v2
        with:
          name: arccon-install-artifact
          path: ${{ env.ARCCON_INSTALL_DIR }}
      - name: Configure
        shell: bash
        run: |
          ls -R
          source /env.sh
          cmake -S ${{ env.ARCCORE_SOURCE_DIR }} -B ${{ env.ARCCORE_BUILD_DIR }} -DCMAKE_BUILD_TYPE=${{ env.CM_BUILD_TYPE }} -DCMAKE_INSTALL_PREFIX=${{ env.ARCCORE_INSTALL_DIR }} -DArccon_DIR=${{ env.ARCCON_INSTALL_DIR }}/share/cmake/Arccon -DBUILD_SHARED_LIBS=ON
      - name: Build
        shell: bash
        run: |
          source /env.sh
          cmake --build ${{ env.ARCCORE_BUILD_DIR }}
      - name: Install
        shell: bash
        run: |
          source /env.sh
          cmake --install ${{ env.ARCCORE_BUILD_DIR }}
      - name: Upload build artifact
        uses: actions/upload-artifact@v2
        with:
          name: arccore-build-artifact
          path: |
            ${{ env.ARCCORE_BUILD_DIR }}
            !${{ env.ARCCORE_BUILD_DIR }}/**/*.dir
          retention-days: 1
      - name: Upload install artifact
        uses: actions/upload-artifact@v2
        with:
          name: arccore-install-artifact
          path: |
            ${{ env.ARCCORE_INSTALL_DIR }}
          retention-days: 1

  arcdependencies-install:
    needs:
      - arccon-install
    name: arcdependencies-install
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/arcaneframework/centos-gimkl-2018b-arcane:7-latest
      credentials:
        username: ${{ secrets.ci_ifpen_read_packages_username }}
        password: ${{ secrets.ci_ifpen_read_packages_password }}
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository_owner }}/arcdependencies
          path: arcdependencies
          ref: main
          submodules: true
      - name: Download arccon install artifact
        uses: actions/download-artifact@v2
        with:
          name: arccon-install-artifact
      - name: Configure
        shell: bash
        run: |
          source /env.sh
          cmake -S ${{ env.ARCDEPENDENCIES_SOURCE_DIR }} -B ${{ env.ARCDEPENDENCIES_BUILD_DIR }} -DCMAKE_BUILD_TYPE=${{ env.CM_BUILD_TYPE }} -DCMAKE_INSTALL_PREFIX=${{ env.ARCDEPENDENCIES_INSTALL_DIR }} -DArccon_DIR=${{ env.ARCCON_INSTALL_DIR }}/share/cmake/Arccon
      - name: Build
        shell: bash
        run: |
          source /env.sh
          cmake --build ${{ env.ARCDEPENDENCIES_BUILD_DIR }}
      - name: Install
        shell: bash
        run: |
          source /env.sh
          cmake --install ${{ env.ARCDEPENDENCIES_BUILD_DIR }}
      - name: Upload install artifact
        uses: actions/upload-artifact@v2
        with:
          name: arcdependencies-install-artifact
          path: |
            ${{ env.ARCDEPENDENCIES_INSTALL_DIR }}
          retention-days: 1

  axlstar-install:
    needs:
      - arcdependencies-install
    name: axlstar-install
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/arcaneframework/centos-gimkl-2018b-arcane:7-latest
      credentials:
        username: ${{ secrets.ci_ifpen_read_packages_username }}
        password: ${{ secrets.ci_ifpen_read_packages_password }}
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository_owner }}/axlstar
          path: axlstar
          ref: main
          submodules: true
      - name: Download arcdependencies install artifact
        uses: actions/download-artifact@v2
        with:
          name: arcdependencies-install-artifact
      - name: Configure
        shell: bash
        run: |
          source /env.sh
          cmake -S ${{ env.AXLSTAR_SOURCE_DIR }} -B ${{ env.AXLSTAR_BUILD_DIR }} -DCMAKE_BUILD_TYPE=${{ env.CM_BUILD_TYPE }} -DCMAKE_INSTALL_PREFIX=${{ env.AXLSTAR_INSTALL_DIR }} -DArcDependencies_DIR=${{ env.ARCDEPENDENCIES_INSTALL_DIR }}/share/cmake/ArcDependencies
      - name: Build
        shell: bash
        run: |
          source /env.sh
          cmake --build ${{ env.AXLSTAR_BUILD_DIR }}
      - name: Install
        shell: bash
        run: |
          cmake --install ${{ env.AXLSTAR_BUILD_DIR }}
      - name: Upload install artifact
        uses: actions/upload-artifact@v2
        with:
          name: axlstar-install-artifact
          path: |
            ${{ env.AXLSTAR_INSTALL_DIR }}
          retention-days: 1

  arcane-install:
    needs:
      - arccon-install
      - arccore-install
      - arcdependencies-install
      - axlstar-install
    name: arcane-install
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/arcaneframework/centos-gimkl-2018b-arcane:7-latest
      credentials:
        username: ${{ secrets.ci_ifpen_read_packages_username }}
        password: ${{ secrets.ci_ifpen_read_packages_password }}
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: arcane
          submodules: true
      - name: Download arccon install artifact
        uses: actions/download-artifact@v2
        with:
          name: arccon-install-artifact
      - name: Download arccore install artifact
        uses: actions/download-artifact@v2
        with:
          name: arccore-install-artifact
      - name: Download arcdependencies install artifact
        uses: actions/download-artifact@v2
        with:
          name: arcdependencies-install-artifact
      - name: Download axlstar install artifact
        uses: actions/download-artifact@v2
        with:
          name: axlstar-install-artifact
      - name: Configure
        shell: bash
        run: |
          source /env.sh
          cmake -S ${{ env.ARCANE_SOURCE_DIR }} -B ${{ env.ARCANE_BUILD_DIR }} -DCMAKE_BUILD_TYPE=${{ env.CM_BUILD_TYPE }} -DCMAKE_INSTALL_PREFIX=${{ env.ARCANE_INSTALL_DIR }} -DArccon_DIR=${{ env.ARCCON_INSTALL_DIR }}/share/cmake/Arccon -DArccore_DIR=${{ env.ARCCORE_INSTALL_DIR }}/lib/cmake/Arccore -DAxlstar_DIR=${{ env.AXLSTAR_INSTALL_DIR }}/share/cmake/Axlstar -DArcDependencies_DIR=${{ env.ARCDEPENDENCIES_INSTALL_DIR }}/share/cmake/ArcDependencies -DBUILD_SHARED_LIBS=ON -DARCANE_DEFAULT_PARTITIONER=Metis -DARCANE_WANT_TOTALVIEW=ON -DARCANE_WANT_LIBXML2=ON -DARCANE_WANT_LEGACY_CONNECTIVITY=OFF -DARCANE_WANT_CHECK=OFF -DARCANE_WANT_ARCCON_EXPORT_TARGET=OFF
      - name: Build
        shell: bash
        run: |
          source /env.sh
          cmake --build ${{ env.ARCANE_BUILD_DIR }}
      - name: Install
        shell: bash
        run: |
          source /env.sh
          cmake --install ${{ env.ARCANE_BUILD_DIR }}
      - name: Upload build artifact
        uses: actions/upload-artifact@v2
        with:
          name: arcane-build-artifact
          path: |
            ${{ env.ARCANE_BUILD_DIR }}
            !${{ env.ARCANE_BUILD_DIR }}/**/*.dir
          retention-days: 1

  arccore-test:
    needs:
      - arccore-install
    name: arccore-test
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/arcaneframework/centos-gimkl-2018b-arcane:7-latest
      credentials:
        username: ${{ secrets.ci_ifpen_read_packages_username }}
        password: ${{ secrets.ci_ifpen_read_packages_password }}
    strategy:
      fail-fast: false
    steps:
      - name: Download arccore build artifact
        uses: actions/download-artifact@v2
        with:
          name: arccore-build-artifact
      - name: Test
        shell: bash
        run: |
          source /env.sh
          cd ${{ env.ARCCORE_BUILD_DIR }}
          ctest ${{ env.CT_OPTS }}

  arcane-test:
    needs:
      - arcane-install
    name: arcane-test
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/arcaneframework/centos-gimkl-2018b-arcane:7-latest
      credentials:
        username: ${{ secrets.ci_ifpen_read_packages_username }}
        password: ${{ secrets.ci_ifpen_read_packages_password }}
    strategy:
      fail-fast: false
    steps:
      - name: Download arcane build artifact
        uses: actions/download-artifact@v2
        with:
          name: arcane-build-artifact
      - name: Download arccore install artifact
        uses: actions/download-artifact@v2
        with:
          name: arccore-install-artifact
      - name: Download axlstar install artifact
        uses: actions/download-artifact@v2
        with:
          name: axlstar-install-artifact
      - name: Test
        shell: bash
        run: |
          source /env.sh
          cd ${{ env.ARCANE_BUILD_DIR }}
          ctest ${{ env.CT_OPTS }}
